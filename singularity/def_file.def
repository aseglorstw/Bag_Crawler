Bootstrap: docker
From: ros:noetic-perception

%post
    export XDG_CACHE_HOME=/tmp/singularity-cache # pip cache

    # Install Apt packages
    packages="
    gcc
    g++
    bridge-utils
    build-essential
    htop
    net-tools
    screen
    sshpass
    tmux
    vim
    wget
    curl
    git
    python3-pip
    python3-catkin-tools
    python3-pcl
    ros-noetic-ros-numpy
    ros-noetic-rviz
    ros-noetic-tf-conversions
    "
    apt-get update
    apt-get install -y ${packages}

    # Install Python packages
    python_pkgs="
    rosbag
    sys
    timeit
    pathlib
    os
    numpy
    matplotlib.pyplot
    pyvista
    rospy
    pyquaternion
    sensor_msgs.msg
    sensor_msgs.point_cloud2
    tf2_ros
    ros_numpy
    tqdm
    cv2
    datetime
    yaml
    "
    pip install ${python_pkgs}
    pip install git+https://github.com/facebookresearch/pytorch3d.git@stable
    pip install git+https://github.com/autonomousvision/kitti360Scripts.git
    ln -s /usr/bin/python3 /usr/bin/python

    # Setup ROS workspace
    ws=/opt/ros/depthcorr_ws/
    mkdir -p "${ws}/src/"
    cd "${ws}/src/"
    git clone https://github.com/aseglorstw/Bag_Crawler.git
    cd $ws && wstool init src ${ws}/src/depth_correction/dependencies.rosinstall

    # build ROS workspace
    cd "${ws}/" && catkin config --extend /opt/ros/noetic
    cd "${ws}/" && catkin config --cmake-args -DCMAKE_BUILD_TYPE=Release
    cd "${ws}/" && catkin build